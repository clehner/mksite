#!/usr/bin/make -f

mds := $(patsubst %.md,%.html,$(wildcard *.md))
contents := $(patsubst %.content.html,%.html,$(wildcard *.content.html))
md2html := md2html.awk

all: $(mds) $(contents)

%.content.html: %.md
	@$(md2html) $< > $@

%.html: %.content.html %.nav.html _template.html
	@echo rendering $@
	@sed > $@ _template.html\
		-e 's/{title}/$*/g'\
		-e '/{content}/r $*.content.html'\
		-e '/{content}/d'\
		-e '/{link}/r $*.nav.html'\
		-e '/{link}/d'

%.nav.html: _nav.html
	@echo rendering nav for $*
	@sed $< > $@\
		-e 's/href="$*.html"/\0 class="active"/'

_nav.html: _nav _template.html
	@echo rendering nav
	@sed -n 's/.*/$(shell sed -ne 's/\//\\\//g' -e 's/{link}/\\0/pg' _template.html)/pg' _nav > $@

_nav: .FORCE
	@ls | sed -n 's/^\(.*\)\.\(md\|content\.html\)$$/\1/p' > $@.tmp
	@cmp -s $@ $@.tmp || mv $@.tmp $@
	@rm -f $@.tmp

clean:
	rm -f _nav _nav.html *.nav.html $(mds) $(contents)

.FORCE:
.PHONY: .FORCE clean
